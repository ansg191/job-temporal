name: Helm

on:
  push:
    branches: [main]
    paths:
      - "charts/**"
      - ".github/workflows/helm.yml"
  pull_request:
    branches: [main]
    paths:
      - "charts/**"
      - ".github/workflows/helm.yml"

permissions:
  contents: read

jobs:
  # ──────────────────────────────────────────────────────────────────────────
  # lint — validate chart templates without a cluster
  # ──────────────────────────────────────────────────────────────────────────
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.17.0

      - name: Helm lint
        run: helm lint charts/job-temporal

      - name: Helm template (render all templates)
        run: |
          helm template test-release charts/job-temporal \
            --set existingSecret.database.name=db-secret \
            --set existingSecret.server.name=server-secret \
            --set existingSecret.temporal.name=temporal-secret \
            --set existingSecret.worker.name=worker-secret

  # ──────────────────────────────────────────────────────────────────────────
  # kwok-test — deploy chart to a kwok fake cluster and verify K8s resources
  # are created correctly (pods are simulated, not actually running)
  # ──────────────────────────────────────────────────────────────────────────
  kwok-test:
    name: Kwok Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.17.0

      - name: Install kwokctl
        env:
          KWOK_VERSION: v0.7.0
        run: |
          curl -fsSL "https://github.com/kubernetes-sigs/kwok/releases/download/${KWOK_VERSION}/kwokctl-linux-amd64" \
            -o /usr/local/bin/kwokctl
          chmod +x /usr/local/bin/kwokctl
          kwokctl --version

      - name: Create kwok cluster
        run: kwokctl create cluster --name kwok-test --wait 60s

      - name: Create test secrets
        run: |
          kubectl create secret generic ci-db-secret \
            --from-literal=DATABASE_URL="postgres://test:test@localhost/test?sslmode=disable"
          kubectl create secret generic ci-server-secret \
            --from-literal=GITHUB_WEBHOOK_SECRET="test-webhook-secret"
          kubectl create secret generic ci-temporal-secret \
            --from-literal=POSTGRES_USER="temporal" \
            --from-literal=POSTGRES_PWD="temporal" \
            --from-literal=POSTGRES_SEEDS="localhost"
          kubectl create secret generic ci-worker-secret \
            --from-literal=ANTHROPIC_API_KEY="test" \
            --from-literal=OPENAI_API_KEY="test" \
            --from-literal=GITHUB_APP_ID="12345" \
            --from-literal=GITHUB_INSTALL_ID="67890" \
            --from-literal=GITHUB_APP_PRIVATE_KEY="$(printf -- '-----BEGIN RSA PRIVATE KEY-----\nMIIEowIBAAKCAQEA0Z3VS5JJcds3xHn/ygWep4PAtEsHAELbWtHHf1wuGMiTNUd\n-----END RSA PRIVATE KEY-----')" \
            --from-literal=AWS_ACCESS_KEY_ID="test" \
            --from-literal=AWS_SECRET_ACCESS_KEY="test" \
            --from-literal=AWS_REGION="auto" \
            --from-literal=AWS_ENDPOINT_URL="https://test.r2.cloudflarestorage.com" \
            --from-literal=R2_BUCKET="test-bucket" \
            --from-literal=R2_PUBLIC_BASE_URL="https://test.example.com"

      - name: Helm install (no wait — kwok pods are simulated)
        run: |
          helm install job-temporal charts/job-temporal \
            --values charts/job-temporal/ci/test-values.yaml \
            --set worker.enabled=false \
            --wait=false \
            --timeout 60s

      - name: Verify Kubernetes resources were created
        run: |
          echo "=== Deployments ==="
          kubectl get deployments -o wide
          echo "=== Services ==="
          kubectl get services -o wide
          echo "=== Pods ==="
          kubectl get pods -o wide
          echo "=== Helm status ==="
          helm status job-temporal

      - name: Assert expected resources exist
        run: |
          kubectl get deployment job-temporal-server
          kubectl get deployment job-temporal-trigger-server
          kubectl get deployment job-temporal-temporal
          kubectl get deployment job-temporal-temporal-ui
          kubectl get service job-temporal-server
          kubectl get service job-temporal-trigger-server
          kubectl get service job-temporal-temporal
          kubectl get service job-temporal-temporal-ui

      - name: Delete kwok cluster
        if: always()
        run: kwokctl delete cluster --name kwok-test

  # ──────────────────────────────────────────────────────────────────────────
  # kind-test — deploy chart to a real kind cluster, run helm test
  # ──────────────────────────────────────────────────────────────────────────
  kind-test:
    name: Kind Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.17.0

      - name: Create kind cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: kind-test

      - name: Deploy PostgreSQL for CI testing
        run: |
          # Add Bitnami repo and deploy a single-node postgres for both
          # the application DB and the Temporal DB.
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo update

          helm install ci-postgres bitnami/postgresql \
            --set auth.postgresPassword=ci-postgres \
            --set auth.database=job-temporal \
            --wait --timeout 120s

      - name: Initialise Temporal database
        run: |
          # Wait for postgres to be ready then create the temporal database.
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=postgresql --timeout=120s
          kubectl exec -i svc/ci-postgres-postgresql -- \
            psql -U postgres -c "CREATE DATABASE temporal;" || true
          kubectl exec -i svc/ci-postgres-postgresql -- \
            psql -U postgres -c "CREATE USER temporal WITH PASSWORD 'temporal';" || true
          kubectl exec -i svc/ci-postgres-postgresql -- \
            psql -U postgres -c "GRANT ALL PRIVILEGES ON DATABASE temporal TO temporal;" || true

      - name: Create test secrets
        run: |
          kubectl create secret generic ci-db-secret \
            --from-literal=DATABASE_URL="postgres://postgres:ci-postgres@ci-postgres-postgresql.default.svc.cluster.local:5432/job-temporal?sslmode=disable"
          kubectl create secret generic ci-server-secret \
            --from-literal=GITHUB_WEBHOOK_SECRET="test-webhook-secret"
          kubectl create secret generic ci-temporal-secret \
            --from-literal=POSTGRES_USER="temporal" \
            --from-literal=POSTGRES_PWD="temporal" \
            --from-literal=POSTGRES_SEEDS="ci-postgres-postgresql.default.svc.cluster.local"
          kubectl create secret generic ci-worker-secret \
            --from-literal=ANTHROPIC_API_KEY="test" \
            --from-literal=OPENAI_API_KEY="test" \
            --from-literal=GITHUB_APP_ID="12345" \
            --from-literal=GITHUB_INSTALL_ID="67890" \
            --from-literal=GITHUB_APP_PRIVATE_KEY="placeholder" \
            --from-literal=AWS_ACCESS_KEY_ID="test" \
            --from-literal=AWS_SECRET_ACCESS_KEY="test" \
            --from-literal=AWS_REGION="auto" \
            --from-literal=AWS_ENDPOINT_URL="https://test.r2.cloudflarestorage.com" \
            --from-literal=R2_BUCKET="test-bucket" \
            --from-literal=R2_PUBLIC_BASE_URL="https://test.example.com"

      - name: Helm install
        run: |
          helm install job-temporal charts/job-temporal \
            --values charts/job-temporal/ci/test-values.yaml \
            --timeout 180s \
            --wait

      - name: Show pod status
        if: always()
        run: kubectl get pods -o wide

      - name: Run helm test
        run: helm test job-temporal --timeout 120s

      - name: Show test logs on failure
        if: failure()
        run: |
          kubectl get pods -o wide
          kubectl logs -l "helm.sh/chart" --prefix || true
