{{/* Shared ExternalSecret: DATABASE_URL, used by server, trigger-server, and worker. */}}
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "job-temporal.sharedSecretName" . }}
  labels:
    {{- include "job-temporal.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.externalSecrets.refreshInterval }}
  secretStoreRef:
    name: {{ .Values.externalSecrets.secretStoreRef.name }}
    kind: {{ .Values.externalSecrets.secretStoreRef.kind }}
  target:
    name: {{ include "job-temporal.sharedSecretName" . }}
    creationPolicy: Owner
  data:
    - secretKey: DATABASE_URL
      remoteRef:
        key: {{ .Values.externalSecrets.shared.databaseUrlKey }}
---
{{/* Server ExternalSecret: GITHUB_WEBHOOK_SECRET. */}}
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "job-temporal.serverSecretName" . }}
  labels:
    {{- include "job-temporal.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.externalSecrets.refreshInterval }}
  secretStoreRef:
    name: {{ .Values.externalSecrets.secretStoreRef.name }}
    kind: {{ .Values.externalSecrets.secretStoreRef.kind }}
  target:
    name: {{ include "job-temporal.serverSecretName" . }}
    creationPolicy: Owner
  data:
    - secretKey: GITHUB_WEBHOOK_SECRET
      remoteRef:
        key: {{ .Values.externalSecrets.server.githubWebhookSecretKey }}
---
{{/* Worker ExternalSecret: all worker-specific secrets. */}}
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "job-temporal.workerSecretName" . }}
  labels:
    {{- include "job-temporal.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.externalSecrets.refreshInterval }}
  secretStoreRef:
    name: {{ .Values.externalSecrets.secretStoreRef.name }}
    kind: {{ .Values.externalSecrets.secretStoreRef.kind }}
  target:
    name: {{ include "job-temporal.workerSecretName" . }}
    creationPolicy: Owner
  data:
    - secretKey: OPENAI_API_KEY
      remoteRef:
        key: {{ .Values.externalSecrets.worker.openaiApiKeyKey }}
    - secretKey: ANTHROPIC_API_KEY
      remoteRef:
        key: {{ .Values.externalSecrets.worker.anthropicApiKeyKey }}
    - secretKey: GITHUB_APP_ID
      remoteRef:
        key: {{ .Values.externalSecrets.worker.githubAppIdKey }}
    - secretKey: GITHUB_INSTALL_ID
      remoteRef:
        key: {{ .Values.externalSecrets.worker.githubInstallIdKey }}
    - secretKey: GITHUB_APP_PRIVATE_KEY
      remoteRef:
        key: {{ .Values.externalSecrets.worker.githubAppPrivateKeyKey }}
    - secretKey: AWS_ACCESS_KEY_ID
      remoteRef:
        key: {{ .Values.externalSecrets.worker.awsAccessKeyIdKey }}
    - secretKey: AWS_SECRET_ACCESS_KEY
      remoteRef:
        key: {{ .Values.externalSecrets.worker.awsSecretAccessKeyKey }}
